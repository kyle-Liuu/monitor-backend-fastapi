# AI 智能监控视频行为分析系统 - 后端

## 项目概述

这是一个基于 Python + FastAPI 的 AI 智能监控视频行为分析系统后端，采用模块化、事件驱动的架构设计，支持视频流复用和模型实例共享，实现了算法和视频流的多对多关系。

## 🚀 核心特性

### ✅ 已完成功能

- **🎯 核心架构**：模块化、事件驱动设计，支持高并发处理
- **📊 数据库系统**：SQLite + 统一 ID 命名，支持数据完整性验证
- **🌊 流管理系统**：支持视频流复用和状态监控
- **🤖 算法管理系统**：支持动态加载和模型实例共享
- **📋 任务管理系统**：完整的任务生命周期管理
- **📡 事件系统**：异步通信和优先级处理
- **🧪 测试体系**：56 个测试用例，100%通过率
- **📦 算法包管理**：渐进式设计，支持简化版和标准版
- **⚡ 启动脚本**：一键启动和数据库管理

### 🎯 技术亮点

- **🔒 单例模式**：确保服务全局唯一，避免资源冲突
- **📡 事件驱动**：松耦合的模块通信，提高系统响应性
- **🔄 资源复用**：流复用和模型实例共享，优化资源利用
- **📈 渐进式设计**：支持不同技术水平的用户
- **✅ 完整测试**：高覆盖率的测试体系，确保系统稳定性
- **🏷️ 统一命名**：规范的 ID 命名约定，提高代码可维护性

## 🏗️ 系统架构

### 核心模块

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              FastAPI 应用层                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  /auth  /menu  /user  /streams  /algorithms  /tasks  /analyzer             │
│     │      │      │       │           │         │        │                  │
│     └──────┴──────┴───────┴───────────┴─────────┴────────┴──────────────────┘
│                                    │
│                              AnalyzerService                                │
│                              (协调服务 - 单例模式)                           │
│                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                             核心模块层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  StreamModule    AlgorithmModule    TaskModule    EventBus                  │
│  (流管理)        (算法管理)         (任务管理)    (事件总线)                 │
│       │               │               │              │                      │
│       └───────────────┼───────────────┴──────────────┼──────────────────────┘
│                       │                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                             数据访问层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  StreamDAO    AlgorithmDAO    TaskDAO    ConnectionPool                     │
│  (流数据)     (算法数据)      (任务数据)   (连接池)                         │
│       │             │            │            │                              │
│       └─────────────┴────────────┴────────────┴──────────────────────────────┘
│                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                             数据存储层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  SQLite Database  │  Shared Memory  │  File System                          │
│  (关系数据)       │  (帧缓存)        │  (模型文件/日志)                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 多对多关系设计

- **视频流 ↔ 算法关系**：支持一个流多个算法，一个算法处理多个流
- **模型实例池管理**：自动负载均衡，最多 3 个实例
- **流复用机制**：多个任务可共享同一个视频流
- **资源优化**：自动清理空闲实例，优化内存使用

## 📦 算法包管理系统

### 算法包结构

```
algorithms/
├── base_classes.py              # 基类定义
├── installed/                   # 已安装算法包
│   └── algocf6c488d/          # 算法包实例
│       ├── model/              # 模型目录
│       │   ├── simple_yolo.py  # 简化版模型
│       │   └── yolov8_model/   # 模型文件
│       ├── postprocessor/      # 后处理目录
│       │   ├── simple_postprocessor.py  # 简化版后处理
│       │   └── postprocessor.yaml       # 配置文件
│       └── package_config.yaml # 包配置
└── registry/                   # 算法注册表
```

### 渐进式设计

- **简化版**：适合非专业人员，代码简单易懂
- **标准版**：继承基类，功能完整，适合专业人员
- **自动选择**：根据配置和基类可用性自动选择版本

## 🧪 测试体系

### 测试覆盖

- **56 个测试用例**，100%通过率
- **模块化测试**：每个核心模块都有独立测试
- **集成测试**：测试模块间协作
- **事件总线测试**：确保事件系统正常工作

### 测试模块

- `test_service.py` - 分析器服务测试
- `test_stream_module.py` - 流模块测试
- `test_task_module.py` - 任务模块测试
- `test_algorithm_module.py` - 算法模块测试
- `test_event_bus.py` - 事件总线测试
- `test_dao.py` - 数据访问层测试
- `test_shared_memory.py` - 共享内存测试
- `test_id_generator.py` - ID 生成器测试

## 🚀 快速开始

### 环境要求

- Python 3.8+
- Conda 环境 (推荐使用 `rkyolo11`)
- CUDA 支持 (可选，用于 GPU 加速)

### 安装依赖

```bash
# 激活 Conda 环境
conda activate rkyolo11

# 安装依赖
pip install -r requirements.txt
```

### 启动服务

#### 方法 1：使用启动脚本（推荐）

```bash
# Windows
start.bat

# 选择操作：
# 1. 启动服务
# 2. 重置数据库并启动服务
# 3. 退出程序
```

#### 方法 2：手动启动

```bash
# 重置数据库（首次运行）
python reset_db.py

# 启动服务
python run.py
```

### 运行测试

```bash
# 运行所有测试
python -m unittest discover tests/analyzer/ -v

# 或使用批处理脚本
run_analyzer_tests.bat
```

## 📚 API 文档

### 分析器服务接口

- `POST /analyzer/start` - 启动分析器
- `POST /analyzer/stop` - 停止分析器
- `GET /analyzer/status` - 获取状态

### 流管理接口

- `POST /analyzer/streams` - 创建流
- `GET /analyzer/streams` - 获取流列表
- `PUT /analyzer/streams/{id}` - 更新流
- `DELETE /analyzer/streams/{id}` - 删除流

### 任务管理接口

- `POST /analyzer/tasks` - 创建任务
- `GET /analyzer/tasks` - 获取任务列表
- `PUT /analyzer/tasks/{id}` - 更新任务
- `DELETE /analyzer/tasks/{id}` - 删除任务

### 算法管理接口

- `GET /algorithms` - 获取算法列表
- `POST /algorithms/upload` - 上传算法
- `PUT /algorithms/{id}/status` - 更新算法状态

## 🔧 配置说明

### 数据库配置

- **数据库文件**：`app.db`
- **表结构**：统一 ID 命名（`stream_id`, `algo_id`, `task_id`等）
- **初始数据**：包含默认用户和配置

### 算法配置

- **模型文件**：支持 `.pt`, `.onnx` 格式
- **配置文件**：YAML 格式，支持标签映射和颜色配置
- **设备选择**：自动选择 CPU/GPU

### 日志配置

- **日志级别**：INFO, WARNING, ERROR
- **日志文件**：`logs/app.log`
- **轮转策略**：按大小和时间轮转

## 📊 性能特性

### 资源优化

- **视频流复用**：减少重复连接，共享帧缓存
- **模型实例共享**：避免重复加载，负载均衡
- **连接池管理**：数据库连接复用
- **内存管理**：自动清理空闲资源

### 并发处理

- **多线程处理**：事件处理、流处理、推理处理
- **异步通信**：事件驱动架构
- **任务隔离**：每个任务独立状态

### 监控和告警

- **状态监控**：实时监控各模块状态
- **性能指标**：CPU、内存、任务执行时间
- **错误处理**：自动重试和降级处理

## 🔍 故障排除

### 常见问题

1. **事件总线未运行警告**

   - 原因：测试模块未正确启动事件总线
   - 解决：已修复，所有测试模块现在都正确启动事件总线

2. **数据库连接错误**

   - 原因：数据库文件被占用
   - 解决：检查是否有其他进程在使用数据库

3. **模型加载失败**

   - 原因：模型文件路径错误或格式不支持
   - 解决：检查模型文件路径和格式

4. **测试失败**
   - 原因：测试数据不匹配或环境问题
   - 解决：运行 `python reset_db.py` 重置数据库

### 调试技巧

- 查看日志文件：`logs/app.log`
- 使用测试脚本：`run_analyzer_tests.bat`
- 检查数据库：使用 SQLite 工具查看 `app.db`

## 🤝 贡献指南

### 开发环境设置

1. 克隆项目
2. 创建 Conda 环境
3. 安装依赖
4. 运行测试确保环境正常

### 代码规范

- 遵循 PEP 8 编码规范
- 添加适当的注释和文档
- 编写单元测试
- 使用统一的 ID 命名约定

### 提交规范

- 使用清晰的提交信息
- 包含测试用例
- 更新相关文档

## 📄 许可证

本项目采用 MIT 许可证。

## 📞 联系方式

如有问题或建议，请通过以下方式联系：

- 提交 Issue
- 发送邮件
- 参与讨论

---

**🎉 项目状态：生产就绪**

- ✅ 核心功能完整
- ✅ 测试覆盖率高
- ✅ 文档完善
- ✅ 性能优化
- ✅ 错误处理完善
